pipeline {
    agent none
    stages {
        stage('Init') {
            agent any
            steps {
                script {
                    def description = "<a href='$PULL_REQUEST_URL'>$PULL_REQUEST_FROM_REPO_SLUG PR #$PULL_REQUEST_ID</a>"
                    currentBuild.setDescription(description)
                    notifyBitbucket()
                }
            }
        }
        stage('Build') {
            agent {
                docker {
                    image 'circleci/android:api-27-alpha'
                    args "-w /home/circleci/src -u root"
                }
            }
            steps {
                ansiColor('xterm') {
                    sh 'sudo cp /home/circleci/.android $PWD/.android -r'
                    sh 'cd /home/circleci/src'
                    sh 'chmod +x ./gradlew'
                    sh './gradlew checkPullRequest'
                }
            }
        }
    }
    post {
        always {
            node('master') {
                script {
                    currentBuild.result = currentBuild.result ?: 'SUCCESS'
                    notifyBitbucket()
                }
            }
        }

        success {
            node('master') {
                script {
                    def branchUrlPrefix = "https://stash.wanari.com/projects/MEETIM/repos/meeting-timer-android/commits?until=refs/heads"
                    rocketSend channel: 'meetingtimer-technical', rawMessage: true, message: """
:white_check_mark:  SUCCESSFUL BUILD
---------------- 
>>> From [**$PULL_REQUEST_FROM_BRANCH**]($branchUrlPrefix/$PULL_REQUEST_FROM_BRANCH) into [**$PULL_REQUEST_TO_BRANCH**]($branchUrlPrefix/$PULL_REQUEST_TO_BRANCH)
>>> Pull Request ID: [**#$PULL_REQUEST_ID**]($PULL_REQUEST_URL)"""
                }
            }
        }

        failure {
            node('master') {
                script {
                    def branchUrlPrefix = "https://stash.wanari.com/projects/MEETIM/repos/meeting-timer-android/commits?until=refs/heads"
                    rocketSend channel: 'meetingtimer-technical', rawMessage: true, message: """
:broken_heart:  BUILD FAILED
---------------- 
>>> From [**$PULL_REQUEST_FROM_BRANCH**]($branchUrlPrefix/$PULL_REQUEST_FROM_BRANCH) into [**$PULL_REQUEST_TO_BRANCH**]($branchUrlPrefix/$PULL_REQUEST_TO_BRANCH)
>>> Pull Request ID: [**#$PULL_REQUEST_ID**]($PULL_REQUEST_URL)"""
                }
            }
        }
    }
}